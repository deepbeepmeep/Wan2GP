# sage-wheels.yml
# Manually-triggered workflow that extracts the pre-compiled SageAttention wheel
# from the sage-compile build stage and publishes it as a GitHub pre-release asset.
#
# How it works:
#   1. Builds the 'sage-compile' Dockerfile stage using the GHA BuildKit cache.
#      If a successful docker-build.yml run has completed, this stage is a full
#      cache hit and completes in seconds — no NVCC recompilation.
#   2. Runs a short-lived container from that image to copy out dist/*.whl.
#   3. Creates a GitHub pre-release tagged sage-<version>-cu128-cp310 and
#      uploads the wheel as an asset.
#
# Once a wheel is published, update the 'deps' stage in the Dockerfile to
# install from the release URL instead of compiling from source:
#
#   RUN pip install --no-deps \
#       https://github.com/<owner>/Wan2GP/releases/download/<tag>/<wheel>.whl
#
# To trigger: Actions tab → "SageAttention Pre-built Wheel" → Run workflow.
---
name: SageAttention Pre-built Wheel

on:
  workflow_dispatch:
    inputs:
      sage_tag:
        description: SageAttention git tag baked into the current Dockerfile
        required: true
        default: v2.2.0

jobs:
  extract-wheel:
    name: Extract wheel from build cache
    runs-on: ubuntu-latest
    permissions:
      contents: write   # required to create releases
      packages: read    # required to read GHA cache

    steps:
      - name: Checkout repository
        # actions/checkout v4
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5

      - name: Set up Docker Buildx
        # docker/setup-buildx-action v3
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f

      - name: Build sage-tools stage
        # docker/build-push-action v6
        uses: docker/build-push-action@10e90e3645eae34f1e60eeb005ba3a3d33f178e8
        with:
          context: .
          target: sage-tools
          # load: true makes the image available to the local Docker daemon
          # so we can run a container from it in the next step.
          load: true
          push: false
          tags: sage-tools-local:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CUDA_ARCHITECTURES=8.0;8.6;8.9;9.0+PTX

      - name: Extract wheel from image
        run: |
          mkdir -p dist
          docker run --rm \
            -v "$(pwd)/dist:/out" \
            sage-tools-local:latest \
            bash -c "cp /tmp/sa_dist/*.whl /out/"
          ls -lh dist/

      - name: Publish pre-release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          WHEEL=$(ls dist/*.whl | head -1)
          WHEEL_NAME=$(basename "$WHEEL")
          # If triggered by push, sage_tag input is empty. Fallback to extracting from Dockerfile.
          SAGE_VERSION="${{ inputs.sage_tag }}"
          if [ -z "$SAGE_VERSION" ]; then
            SAGE_VERSION=$(grep -oP 'ARG SAGE_VERSION="\K[v0-9.]+' Dockerfile | head -1)
          fi
          
          TAG="sage-${SAGE_VERSION}-cu128-cp310"

          cat > /tmp/release-notes.md << NOTES
          Pre-built SageAttention wheel for the Wan2GP Docker image.

          Architecture coverage: sm_80, sm_86, sm_89 (Ampere/Ada), sm_90 (Hopper),
          plus forward-compatible PTX for Blackwell (sm_120 JIT via CUDA driver).

          Built with: CUDA 12.8 | Python 3.10 | Linux x86_64

          To use: replace the SageAttention compile block in the Dockerfile deps stage:
            RUN pip install --no-deps \
                https://github.com/${{ github.repository }}/releases/download/${TAG}/${WHEEL_NAME}
          NOTES

          # Delete existing tag if we are re-pushed to the same infra version
          gh release delete "$TAG" --yes || true
          git push --delete origin "$TAG" || true

          gh release create "$TAG" \
            --title "SageAttention ${SAGE_VERSION} wheel (CUDA 12.8 / Python 3.10 / Linux x86_64)" \
            --notes-file /tmp/release-notes.md \
            --prerelease \
            --latest=false \
            "$WHEEL"
